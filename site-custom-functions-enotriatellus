<?php
/**
 * Plugin Name: Site Custom Functions
 * Description: Plugin che raccoglie funzioni custom. Aggiunge un testo all'email di conferma ordine se l'ordine contiene determinati product/variation ID.
 * Version: 1.1.0
 * Author: Marchetti Design
 */

if ( ! defined( 'ABSPATH' ) ) exit; // Sicurezza: blocca accesso diretto


add_action( 'woocommerce_email_before_order_table', 'am_add_text_for_specific_product', 10, 4 );

function am_add_text_for_specific_product( $order, $sent_to_admin, $plain_text, $email ) {

    // Solo email cliente "ordine completato", non admin
    if ( $sent_to_admin || ! isset( $email->id ) || $email->id !== 'customer_completed_order' ) {
        return;
    }

    if ( ! $order || ! is_a( $order, 'WC_Order' ) ) {
        return;
    }

    // ID prodotto/variazione da intercettare
    $target_product_ids = array( 1234, 5678, 9012 );

    // Testi (HTML / Plain)
    $text_html  = '<p><strong>Grazie! ðŸŽ‰</strong> Ti contatteremo a breve via email per confermare la prenotazione.</p>';
    $text_plain = "Grazie! ðŸŽ‰ Ti contatteremo a breve via email per confermare la prenotazione.\n\n";

    foreach ( $order->get_items( 'line_item' ) as $item ) {
        $product_id   = (int) $item->get_product_id();
        $variation_id = (int) $item->get_variation_id();

        if ( in_array( $product_id, $target_product_ids, true ) || ( $variation_id && in_array( $variation_id, $target_product_ids, true ) ) ) {
            echo $plain_text ? wp_strip_all_tags( $text_plain ) : wp_kses_post( $text_html );
            break;
        }
    }
}
